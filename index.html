<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SAGA | CARGO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/controls/OrbitControls.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap');
        body { background: #020617; font-family: 'Inter', sans-serif; color: #f1f5f9; margin: 0; overflow: hidden; }
        .glass { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); }
        .neon-text { text-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .ui-overlay { position: relative; z-index: 10; pointer-events: none; height: 100vh; display: flex; flex-direction: column; justify-content: space-between; padding: 1.5rem; }
        .ui-overlay * { pointer-events: auto; }
        input, select { background: #1e293b !important; border: 1px solid #334155 !important; color: white !important; border-radius: 8px !important; }
        .btn-play { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); transition: all 0.3s; }
        .btn-play:hover { transform: scale(1.1); box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); }
        @keyframes pulse-border { 0% { border-color: rgba(59, 130, 246, 0.5); } 50% { border-color: rgba(59, 130, 246, 1); } 100% { border-color: rgba(59, 130, 246, 0.5); } }
        .active-border { animation: pulse-border 2s infinite; border-width: 2px; }
    </style>
</head>
<body class="overflow-hidden">

    <div id="canvas-container"></div>

    <div class="ui-overlay">
        <header class="flex justify-between items-start">
            <div class="glass p-4 rounded-2xl border-l-4 border-blue-500 shadow-2xl">
                <h1 style="font-family: 'Orbitron'" class="font-bold text-xl tracking-tighter neon-text">SAGA CARGO <span class="text-white">V1.2</span></h1>
                <div class="flex items-center gap-2 mt-1">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                    <p class="text-[9px] uppercase tracking-widest text-slate-400 font-bold">FUSAGASUGA|COLOMBIA</p>
                </div>
            </div>
            <button onclick="toggleMenu()" class="md:hidden glass w-12 h-12 rounded-full text-blue-400 flex items-center justify-center">
                <i class="fas fa-bars"></i>
            </button>
        </header>

        <div class="flex flex-col items-center gap-4 mb-6">
            <div class="glass p-4 rounded-3xl shadow-2xl border border-white/5 flex items-center gap-6 min-w-[320px] md:min-w-[600px]">
                <button id="playBtn" onclick="toggleAutoPlay()" class="btn-play w-14 h-14 rounded-full flex items-center justify-center text-white shadow-lg">
                    <i id="playIcon" class="fas fa-play text-xl ml-1"></i>
                </button>

                <div class="flex-1 space-y-2">
                    <div class="flex justify-between items-end">
                        <span class="text-[10px] text-slate-500 font-bold uppercase">Progreso de Carga</span>
                        <span id="counter" class="text-xs font-mono text-blue-400">0 / 0</span>
                    </div>
                    <input id="loadSlider" type="range" value="0" min="0" max="100" class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500" oninput="manualControl(this.value)">
                </div>

                <button onclick="resetApp()" class="text-slate-500 hover:text-white transition p-2"><i class="fas fa-sync-alt"></i></button>
            </div>
        </div>
    </div>

    <aside id="sidebar" class="fixed right-0 top-0 h-full w-80 md:w-96 glass border-l border-white/10 p-6 z-50 transform translate-x-full md:translate-x-0 transition-transform duration-500 overflow-y-auto">
        <div class="flex justify-between items-center mb-8">
            <h2 style="font-family: 'Orbitron'" class="text-sm font-bold tracking-widest uppercase">Panel de Control</h2>
            <button onclick="toggleMenu()" class="md:hidden text-slate-400 text-2xl">&times;</button>
        </div>

        <div class="space-y-6">
            <div class="space-y-3">
                <label class="text-[10px] font-bold text-slate-500 uppercase">Configuraci√≥n de Espacio</label>
                <select id="mode" class="w-full p-3 text-sm" onchange="startSim()">
                    <option value="truck">üöõ Tractocami√≥n (Mula)</option>
                    <option value="rack">üèóÔ∏è Estanter√≠a Libre</option>
                </select>
                <div class="grid grid-cols-3 gap-2">
                    <input id="cw" type="number" value="240" class="p-2 text-center" title="Ancho">
                    <input id="ch" type="number" value="260" class="p-2 text-center" title="Alto">
                    <input id="cd" type="number" value="1200" class="p-2 text-center" title="Largo">
                </div>
            </div>

            <div class="space-y-3">
                <label class="text-[10px] font-bold text-slate-500 uppercase">Dimensiones de la Caja</label>
                <div class="grid grid-cols-3 gap-2">
                    <input id="bw" type="number" value="40" class="p-2 text-center">
                    <input id="bh" type="number" value="40" class="p-2 text-center">
                    <input id="bd" type="number" value="40" class="p-2 text-center">
                </div>
                <label class="text-[10px] font-bold text-slate-500 uppercase">Cantidad Total</label>
                <input id="bq" type="number" value="500" class="w-full p-3">
            </div>

            <button onclick="startSim()" class="w-full py-4 rounded-xl bg-blue-600 hover:bg-blue-500 font-bold text-xs tracking-widest transition-all shadow-lg shadow-blue-900/40 uppercase">
                Calcular y Renderizar
            </button>

            <div class="bg-slate-900/50 p-4 rounded-2xl border border-white/5 space-y-4">
                <div class="flex justify-between text-xs">
                    <span class="text-slate-500">Ocupaci√≥n:</span>
                    <span id="effText" class="text-emerald-400 font-bold">0%</span>
                </div>
                <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden">
                    <div id="effBar" class="h-full bg-blue-500 transition-all duration-1000" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </aside>

<script>
let scene, camera, renderer, controls, mainGroup;
let boxMeshes = [];
let isPlaying = false;
let playInterval;

function initCore() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x020617);
    scene.fog = new THREE.Fog(0x020617, 500, 5000);

    const container = document.getElementById('canvas-container');
    camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 1, 10000);
    camera.position.set(1200, 800, 1500);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    container.appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // Luces mejoradas
    scene.add(new THREE.AmbientLight(0xffffff, 0.4));
    const mainLight = new THREE.DirectionalLight(0xffffff, 1);
    mainLight.position.set(500, 1000, 750);
    scene.add(mainLight);

    const fillLight = new THREE.PointLight(0x3b82f6, 0.5);
    fillLight.position.set(-500, 500, -500);
    scene.add(fillLight);

    // Grid de suelo industrial
    const grid = new THREE.GridHelper(5000, 60, 0x1e293b, 0x0f172a);
    grid.position.y = -140;
    scene.add(grid);

    window.addEventListener('resize', onWindowResize);
    startSim();
    animate();
}

function startSim() {
    stopAutoPlay();
    const CW = +cw.value, CH = +ch.value, CD = +cd.value;
    const BW = +bw.value, BH = +bh.value, BD = +bd.value;
    const TOTAL = +bq.value;

    if(mainGroup) scene.remove(mainGroup);
    mainGroup = new THREE.Group();
    boxMeshes = [];

    // --- DISE√ëO DE LA MULA (TRACTOCAMI√ìN) ---
    if(document.getElementById('mode').value === 'truck') {
        const metalMat = new THREE.MeshStandardMaterial({ color: 0x94a3b8, metalness: 0.9, roughness: 0.1 });
        const cabMat = new THREE.MeshStandardMaterial({ color: 0xe11d48, metalness: 0.5, roughness: 0.2 }); // Color Llamativo
        const plasticMat = new THREE.MeshStandardMaterial({ color: 0x0f172a });

        // 1. Trailer (El contenedor transparente)
        const trailerGeo = new THREE.BoxGeometry(CW, CH, CD);
        const trailerMat = new THREE.MeshStandardMaterial({ color: 0x3b82f6, transparent: true, opacity: 0.1, side: THREE.BackSide });
        const trailer = new THREE.Mesh(trailerGeo, trailerMat);
        mainGroup.add(trailer);
        mainGroup.add(new THREE.LineSegments(new THREE.EdgesGeometry(trailerGeo), new THREE.LineBasicMaterial({ color: 0x3b82f6, opacity: 0.2, transparent: true })));

        // 2. Cabezote (Tractor)
        const cabGroup = new THREE.Group();
        // Base/Motor
        const engine = new THREE.Mesh(new THREE.BoxGeometry(CW*0.9, CH*0.6, 180), cabMat);
        engine.position.set(0, -CH*0.2, -CD/2 - 180);
        cabGroup.add(engine);
        // Cabina principal
        const cabMain = new THREE.Mesh(new THREE.BoxGeometry(CW*0.9, CH*0.9, 140), cabMat);
        cabMain.position.set(0, -CH*0.05, -CD/2 - 90);
        cabGroup.add(cabMain);
        // Parrilla frontal (Cromo)
        const grill = new THREE.Mesh(new THREE.BoxGeometry(CW*0.7, CH*0.4, 10), metalMat);
        grill.position.set(0, -CH*0.2, -CD/2 - 275);
        cabGroup.add(grill);
        // Chimeneas de escape
        const pipeGeo = new THREE.CylinderGeometry(8, 8, CH, 16);
        [-1, 1].forEach(side => {
            const pipe = new THREE.Mesh(pipeGeo, metalMat);
            pipe.position.set(side * (CW/2 + 5), CH/2 - 80, -CD/2 - 150);
            cabGroup.add(pipe);
        });
        mainGroup.add(cabGroup);

        // 3. Chasis y Ruedas (10 Ruedas)
        const wheelGeo = new THREE.CylinderGeometry(45, 45, 35, 24);
        const wheelMat = new THREE.MeshStandardMaterial({ color: 0x020617 });
        const wheelPos = [-CD/2 - 180, -CD/2 + 50, -CD/2 + 120, CD/2 - 120, CD/2 - 50];
        wheelPos.forEach(z => {
            [-1, 1].forEach(side => {
                const w = new THREE.Mesh(wheelGeo, wheelMat);
                w.rotation.z = Math.PI/2;
                w.position.set(side * (CW/2), -CH/2 - 50, z);
                mainGroup.add(w);
            });
        });
    } else {
        // Estante Industrial Estilizado
        const rackMat = new THREE.MeshStandardMaterial({ color: 0x334155, metalness: 0.8 });
        [[-1,-1], [1,-1], [-1,1], [1,1]].forEach(p => {
            const post = new THREE.Mesh(new THREE.BoxGeometry(15, CH, 15), rackMat);
            post.position.set(p[0]*(CW/2), 0, p[1]*(CD/2));
            mainGroup.add(post);
        });
    }

    // --- LOGICA DE CAJAS ---
    let count = 0;
    const nx = Math.floor(CW/BW), ny = Math.floor(CH/BH), nz = Math.floor(CD/BD);
    for(let z=0; z<nz; z++) {
        for(let y=0; y<ny; y++) {
            for(let x=0; x<nx; x++) {
                if(count < TOTAL) {
                    const box = new THREE.Mesh(
                        new THREE.BoxGeometry(BW-2, BH-2, BD-2),
                        new THREE.MeshStandardMaterial({ color: 0xf59e0b, roughness: 0.7 })
                    );
                    box.position.set(-CW/2 + x*BW + BW/2, -CH/2 + y*BH + BH/2, -CD/2 + z*BD + BD/2);
                    box.visible = false;
                    box.userData.index = count;
                    mainGroup.add(box);
                    boxMeshes.push(box);
                    count++;
                }
            }
        }
    }

    scene.add(mainGroup);
    
    // UI Updates
    loadSlider.max = boxMeshes.length;
    loadSlider.value = 0;
    document.getElementById('counter').innerText = `0 / ${boxMeshes.length}`;
    const eff = ((count * (BW*BH*BD)) / (CW*CH*CD) * 100).toFixed(1);
    document.getElementById('effText').innerText = eff + "%";
    document.getElementById('effBar').style.width = eff + "%";
}

// CONTROL DE REPRODUCCI√ìN
function toggleAutoPlay() {
    isPlaying ? stopAutoPlay() : startAutoPlay();
}

function startAutoPlay() {
    if(loadSlider.value >= boxMeshes.length) loadSlider.value = 0;
    isPlaying = true;
    document.getElementById('playIcon').className = "fas fa-pause";
    document.getElementById('playBtn').classList.add('active-border');
    
    playInterval = setInterval(() => {
        loadSlider.value = parseInt(loadSlider.value) + 1;
        updateVisibility(loadSlider.value);
        if(loadSlider.value >= boxMeshes.length) stopAutoPlay();
    }, 30);
}

function stopAutoPlay() {
    isPlaying = false;
    clearInterval(playInterval);
    document.getElementById('playIcon').className = "fas fa-play";
    document.getElementById('playBtn').classList.remove('active-border');
}

function updateVisibility(val) {
    boxMeshes.forEach(b => b.visible = b.userData.index < val);
    document.getElementById('counter').innerText = `${val} / ${boxMeshes.length}`;
}

function manualControl(val) {
    stopAutoPlay();
    updateVisibility(val);
}

function resetApp() {
    stopAutoPlay();
    startSim();
}

function toggleMenu() {
    document.getElementById('sidebar').classList.toggle('translate-x-full');
}

function onWindowResize() {
    const container = document.getElementById('canvas-container');
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}

initCore();
</script>
</body>
</html>
