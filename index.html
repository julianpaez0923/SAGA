<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SAGA | COLOMBIA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&family=JetBrains+Mono:wght@400;800&display=swap');

        :root {
            --bg: #09090b;
            --panel: rgba(24, 24, 27, 0.92);
            --border: rgba(255, 255, 255, 0.1);
            --primary: #3b82f6;
        }

        body { 
            background: var(--bg); 
            color: #e4e4e7; 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Inter', sans-serif;
            touch-action: none; /* Evita zoom accidental en m贸viles */
        }
        
        .glass {
            background: var(--panel);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
        }
        
        /* Ajustes de scroll para el panel lateral en m贸viles */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }

        input, select {
            background: #27272a; border: 1px solid #3f3f46; color: white;
            padding: 10px; border-radius: 8px; font-size: 14px; width: 100%; font-family: 'JetBrains Mono', monospace;
        }

        /* UI Din谩mica */
        #ui-layer { 
            position: absolute; 
            inset: 0; 
            z-index: 10; 
            pointer-events: none; 
            display: flex; 
            flex-direction: column;
            padding: 12px;
        }

        .pointer-auto { pointer-events: auto; }

        /* Responsividad: Panel Lateral */
        #config-panel {
            position: fixed;
            right: -100%;
            top: 0;
            height: 100%;
            width: 85%;
            max-width: 350px;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
        }

        #config-panel.open { right: 0; }

        @media (min-width: 1024px) {
            #config-panel { position: relative; right: 0; width: 350px; height: auto; border-radius: 12px; }
            #ui-layer { flex-direction: row; justify-content: space-between; }
        }
    </style>
</head>
<body>

    <div id="canvas-layer" style="position: fixed; inset: 0;"></div>

    <button onclick="togglePanel()" class="lg:hidden fixed top-4 right-4 z-[60] bg-blue-600 p-3 rounded-full shadow-lg pointer-auto">
        <i class="fas fa-cog" id="cog-icon"></i>
    </button>

    <div id="ui-layer">
        <div class="w-full lg:w-72 flex flex-col gap-3 pointer-auto">
            <div class="glass p-4 rounded-xl border-l-4 border-blue-500">
                <h1 class="font-bold text-base flex items-center gap-2">
                    <i class="fas fa-layer-group text-blue-500"></i> SAGA CARGO
                </h1>
                <div id="ai-feedback" class="mt-2 p-2 bg-blue-900/20 rounded border border-blue-500/30 hidden">
                    <p id="ai-text" class="text-[10px] text-blue-300 leading-tight"></p>
                </div>
            </div>

            <div class="glass p-4 rounded-xl space-y-2">
                <div class="flex justify-between text-[10px] font-bold text-gray-400">
                    <span>EFICIENCIA</span>
                    <span id="stat-eff" class="text-white">0%</span>
                </div>
                <div class="h-1.5 bg-gray-800 rounded-full overflow-hidden">
                    <div id="bar-eff" class="h-full bg-blue-500 w-0 transition-all duration-700"></div>
                </div>
                <div class="flex justify-between items-center pt-1">
                    <div><span class="text-[9px] block text-gray-500">CAJAS</span><span id="stat-count" class="font-mono text-sm">0</span></div>
                    <div class="text-right"><span class="text-[9px] block text-gray-500">PESO</span><span id="stat-weight" class="font-mono text-sm">0 kg</span></div>
                </div>
            </div>
        </div>

        <div class="fixed bottom-6 left-1/2 -translate-x-1/2 flex gap-3 pointer-auto z-40">
            <button onclick="toggleSim()" id="btn-sim" class="glass px-5 py-3 rounded-2xl flex flex-col items-center min-w-[70px]">
                <i class="fas fa-play text-xs mb-1"></i>
                <span class="text-[8px] font-bold uppercase">F铆sica</span>
            </button>
            <button onclick="runAutoAI()" class="bg-emerald-600/80 backdrop-blur px-5 py-3 rounded-2xl flex flex-col items-center min-w-[70px] border border-emerald-400/50">
                <i class="fas fa-brain text-xs mb-1"></i>
                <span class="text-[8px] font-bold uppercase">Auto-IA</span>
            </button>
        </div>

        <div id="config-panel" class="glass p-6 overflow-y-auto custom-scroll pointer-auto flex flex-col gap-5">
            <h2 class="text-xs font-bold text-blue-400 uppercase tracking-widest border-b border-white/10 pb-2">Configuraci贸n</h2>

            <section class="space-y-3">
                <label class="text-[10px] font-bold text-gray-500">CONTENEDOR</label>
                <select id="env-type" onchange="setEnvPreset()">
                    <option value="truck"> Cami贸n Est谩ndar</option>
                    <option value="cnt20"> Contenedor 20'</option>
                    <option value="cnt40"> Contenedor 40'</option>
                    <option value="pallet"> Pallet (1.2x1.0)</option>
                </select>
                <div class="grid grid-cols-3 gap-2">
                    <input type="number" id="env-w" value="240" placeholder="Ancho">
                    <input type="number" id="env-h" value="260" placeholder="Alto">
                    <input type="number" id="env-d" value="1200" placeholder="Largo">
                </div>
            </section>

            <section class="space-y-3">
                <label class="text-[10px] font-bold text-gray-500">DIMENSIONES CAJA (cm)</label>
                <div class="grid grid-cols-3 gap-2">
                    <input type="number" id="box-w" value="40">
                    <input type="number" id="box-h" value="40">
                    <input type="number" id="box-d" value="60">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="box-mass" value="15" title="Peso Kg">
                    <input type="number" id="box-qty" value="300" title="Cant. M谩xima">
                </div>
            </section>

            <section class="space-y-3">
                <label class="text-[10px] font-bold text-gray-500">APILADO</label>
                <select id="algo-mode" class="text-yellow-500 font-bold">
                    <option value="column"> Columnar</option>
                    <option value="brick">П Traba (Ladrillo)</option>
                    <option value="pinwheel"> Molinillo</option>
                    <option value="pyramid"> Piramidal</option>
                </select>
            </section>

            <button onclick="renderScenario(); closePanelOnMobile();" class="mt-auto bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl text-xs uppercase tracking-wider transition-all">
                Generar Carga
            </button>
        </div>
    </div>

<script>
let scene, camera, renderer, controls, world;
let meshes = [], bodies = [];
let isSimulating = false;
let occupiedBoxes = [];

function init() {
    const container = document.getElementById('canvas-layer');
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x09090b);

    camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 1, 5000);
    camera.position.set(600, 700, 1000);

    renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Optimizaci贸n de rendimiento
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = window.innerWidth > 1024; // Sombras solo en PC
    container.appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.maxDistance = 3000;

    world = new CANNON.World();
    world.gravity.set(0, -9.82, 0);
    // Optimizaci贸n f铆sica para m贸viles
    world.solver.iterations = 5; 

    setupSceneEssentials();
    
    window.addEventListener('resize', onWindowResize);
    animate();
    renderScenario();
}

function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

function togglePanel() {
    const panel = document.getElementById('config-panel');
    const icon = document.getElementById('cog-icon');
    panel.classList.toggle('open');
    icon.classList.toggle('fa-cog');
    icon.classList.toggle('fa-times');
}

function closePanelOnMobile() {
    if(window.innerWidth < 1024) togglePanel();
}

// --- LOGICA DE CARGA (Simplificada para rendimiento) ---
function renderScenario() {
    meshes.forEach(m => scene.remove(m));
    bodies.forEach(b => world.removeBody(b));
    meshes = []; bodies = []; occupiedBoxes = [];
    isSimulating = false;

    const ENV = { w: +document.getElementById('env-w').value, h: +document.getElementById('env-h').value, d: +document.getElementById('env-d').value };
    const BOX = { w: +document.getElementById('box-w').value, h: +document.getElementById('box-h').value, d: +document.getElementById('box-d').value, mass: +document.getElementById('box-mass').value, max: +document.getElementById('box-qty').value };
    const ALGO = document.getElementById('algo-mode').value;

    // Contenedor Visual
    const containerGeo = new THREE.BoxGeometry(ENV.w, ENV.h, ENV.d);
    const line = new THREE.LineSegments(new THREE.EdgesGeometry(containerGeo), new THREE.LineBasicMaterial({ color: 0x3b82f6 }));
    line.position.y = ENV.h/2;
    scene.add(line);
    meshes.push(line);

    const boxMat = new THREE.MeshStandardMaterial({ color: 0xb48a5f, roughness: 0.8 });
    let count = 0;

    // Loop de generaci贸n optimizado
    const layers = Math.floor(ENV.h / BOX.h);
    for (let l = 0; l < layers; l++) {
        let py = l * BOX.h + BOX.h/2;
        for (let x = -ENV.w/2 + BOX.w/2; x < ENV.w/2; x += BOX.w) {
            for (let z = -ENV.d/2 + BOX.d/2; z < ENV.d/2; z += BOX.d) {
                if(count >= BOX.max) break;
                
                // L贸gica de algoritmo simple
                if(ALGO === 'pyramid' && (Math.abs(x) > (ENV.w/2 - l*20) || Math.abs(z) > (ENV.d/2 - l*20))) continue;
                
                createBox(x, py, z, BOX.w, BOX.h, BOX.d, BOX.mass, boxMat);
                count++;
            }
        }
    }

    updateStats(count, BOX, ENV);
}

function createBox(x, y, z, w, h, d, mass, mat) {
    const mesh = new THREE.Mesh(new THREE.BoxGeometry(w-1, h-1, d-1), mat);
    mesh.position.set(x, y, z);
    scene.add(mesh);
    meshes.push(mesh);

    const body = new CANNON.Body({ mass: mass, shape: new CANNON.Box(new CANNON.Vec3(w/2, h/2, d/2)) });
    body.position.set(x, y, z);
    body.sleep();
    world.addBody(body);
    bodies.push(body);
    body.initPos = body.position.clone();
    body.initQuat = body.quaternion.clone();
}

function updateStats(count, BOX, ENV) {
    const eff = ((count * (BOX.w * BOX.h * BOX.d)) / (ENV.w * ENV.h * ENV.d) * 100).toFixed(1);
    document.getElementById('stat-count').innerText = count;
    document.getElementById('stat-weight').innerText = (count * BOX.mass) + " kg";
    document.getElementById('stat-eff').innerText = eff + "%";
    document.getElementById('bar-eff').style.width = eff + "%";
}

function toggleSim() {
    isSimulating = !isSimulating;
    const btn = document.getElementById('btn-sim');
    if(isSimulating) {
        bodies.forEach(b => b.wakeUp());
        btn.classList.add('bg-blue-600');
    } else {
        renderScenario(); // Reset r谩pido
        btn.classList.remove('bg-blue-600');
    }
}

function runAutoAI() {
    const text = document.getElementById('ai-text');
    document.getElementById('ai-feedback').classList.remove('hidden');
    text.innerText = "Analizando dimensiones...";
    setTimeout(() => {
        document.getElementById('algo-mode').value = "brick";
        text.innerText = "Modo Traba aplicado para m谩xima estabilidad.";
        renderScenario();
    }, 600);
}

function setupSceneEssentials() {
    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const sun = new THREE.DirectionalLight(0xffffff, 0.8);
    sun.position.set(500, 1000, 200);
    scene.add(sun);
    
    const floor = new THREE.Mesh(new THREE.PlaneGeometry(4000, 4000), new THREE.MeshStandardMaterial({ color: 0x18181b }));
    floor.rotation.x = -Math.PI/2;
    scene.add(floor);

    const groundBody = new CANNON.Body({ mass: 0, shape: new CANNON.Plane() });
    groundBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1,0,0), -Math.PI/2);
    world.addBody(groundBody);
}

function animate() {
    requestAnimationFrame(animate);
    if(isSimulating) {
        world.step(1/60);
        for(let i=0; i<bodies.length; i++) {
            if(meshes[i+1]) { // +1 por el contenedor
                meshes[i+1].position.copy(bodies[i].position);
                meshes[i+1].quaternion.copy(bodies[i].quaternion);
            }
        }
    }
    controls.update();
    renderer.render(scene, camera);
}

function setEnvPreset() {
    const type = document.getElementById('env-type').value;
    const w = document.getElementById('env-w'), h = document.getElementById('env-h'), d = document.getElementById('env-d');
    if(type === 'truck') { w.value=240; h.value=260; d.value=1200; }
    if(type === 'cnt20') { w.value=235; h.value=239; d.value=590; }
    if(type === 'cnt40') { w.value=235; h.value=269; d.value=1203; }
    if(type === 'pallet') { w.value=120; h.value=160; d.value=100; }
}

init();
</script>
</body>
</html>
