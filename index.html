<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SAGA 3D |COLOMBIA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/FBXLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fflate/0.7.4/fflate.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap');
        
        :root { --primary: #3b82f6; --surface: rgba(15, 23, 42, 0.95); }
        
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #0f172a; font-family: 'Plus Jakarta Sans', sans-serif; }

        /* PANTALLA DE INICIO */
        #splash-screen { position: fixed; inset: 0; z-index: 9999; background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        .device-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); transition: all 0.3s ease; cursor: pointer; }
        .device-card:hover { border-color: var(--primary); transform: translateY(-5px); background: rgba(59, 130, 246, 0.1); }

        /* INTERFAZ DE USUARIO */
        .glass-panel { background: var(--surface); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); color: white; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .compact-input { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 8px; border-radius: 10px; font-family: 'JetBrains Mono'; font-size: 11px; color: #60a5fa; width: 100%; outline: none; }
        .compact-input:focus { border-color: var(--primary); }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }

        /* ANIMACIONES */
        .pulse-warning { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* AJUSTES M√ìVIL */
        @media (max-width: 768px) {
            #main-ui { width: 100% !important; right: 0 !important; bottom: 0 !important; top: auto !important; height: 60px; transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
            #main-ui.expanded { height: 85vh; }
            .mobile-handle { display: block !important; width: 40px; height: 4px; background: rgba(255,255,255,0.2); margin: 8px auto; border-radius: 2px; }
        }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="text-center mb-12">
            <h1 class="text-5xl font-black text-white tracking-tighter mb-2 italic">SAGA<span class="text-blue-500">3D</span></h1>
            <p class="text-blue-400 text-xs font-bold uppercase tracking-[0.4em]">COLOMBIA </p>
        </div>
        <div class="flex flex-col md:flex-row gap-6">
            <div onclick="startApp('pc')" class="device-card p-12 rounded-[40px] text-center w-72">
                <i class="fas fa-desktop text-5xl text-blue-500 mb-6"></i>
                <h3 class="text-white font-bold uppercase tracking-widest text-sm">Escritorio</h3>
                <p class="text-white/30 text-[10px] mt-2 leading-relaxed">Interfaz completa lateral<br>Control de precisi√≥n</p>
            </div>
            <div onclick="startApp('mobile')" class="device-card p-12 rounded-[40px] text-center w-72">
                <i class="fas fa-mobile-alt text-5xl text-blue-500 mb-6"></i>
                <h3 class="text-white font-bold uppercase tracking-widest text-sm">M√≥vil</h3>
                <p class="text-white/30 text-[10px] mt-2 leading-relaxed">Interfaz t√°ctil optimizada<br>Panel colapsable</p>
            </div>
        </div>
    </div>

    <div id="stats-ui" class="fixed top-6 left-6 z-40 w-72 pointer-events-none hidden">
        <div class="glass-panel p-6 rounded-[30px] border-l-4 border-blue-500 pointer-events-auto">
            <div class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-1">Volumen Ocupado</div>
            <div class="flex items-baseline gap-2">
                <span id="stat-eff" class="text-4xl font-black text-white tracking-tighter">0%</span>
                <span id="overweight-tag" class="text-[9px] font-bold px-2 py-0.5 rounded bg-emerald-500 hidden uppercase">OK</span>
            </div>
            <div class="h-1.5 bg-white/5 rounded-full overflow-hidden mt-4">
                <div id="eff-bar" class="h-full bg-blue-500 w-0 transition-all duration-1000"></div>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-5 pt-4 border-t border-white/5">
                <div>
                    <span class="text-[8px] text-white/40 block uppercase font-bold">Peso Total</span>
                    <span id="stat-weight" class="text-sm font-bold text-white">0 kg</span>
                </div>
                <div class="text-right">
                    <span class="text-[8px] text-white/40 block uppercase font-bold">Unidades</span>
                    <span id="stat-count" class="text-sm font-bold text-white">0</span>
                </div>
            </div>
        </div>
    </div>

    <div id="main-ui" class="fixed top-6 right-6 bottom-6 w-80 z-50 hidden">
        <div class="glass-panel p-5 rounded-[32px] flex flex-col h-full overflow-hidden">
            <div class="mobile-handle hidden"></div>
            
            <div class="flex items-center justify-between mb-6" onclick="toggleMobileUI()">
                <h2 class="font-black text-xl tracking-tight">CONFIG<span class="text-blue-500">3D</span></h2>
                <i id="menu-icon" class="fas fa-sliders-h text-blue-500"></i>
            </div>

            <div id="scroll-content" class="flex-1 overflow-y-auto custom-scroll pr-1 space-y-6">
                <section>
                    <label class="text-[10px] font-black text-white/30 uppercase tracking-[0.2em] mb-3 block">Espacio de Trabajo</label>
                    <select id="vehicle-select" onchange="updateVehicle()" class="compact-input font-bold mb-3">
                        <option value="npr">üöö Cami√≥n NPR (Est√°ndar)</option>
                        <option value="tracto">üöõ Tractomula (Gran Carga)</option>
                        <option value="custom">üõ†Ô∏è Cargar Modelo Pro (.OBJ/.FBX)</option>
                    </select>

                    <div id="custom-tools" class="hidden space-y-4 bg-white/5 p-4 rounded-2xl border border-white/10">
                        <div class="border-2 border-dashed border-blue-500/30 p-4 rounded-xl text-center cursor-pointer hover:bg-blue-500/5" onclick="document.getElementById('file-input').click()">
                            <i class="fas fa-file-import text-blue-500 text-2xl mb-2"></i>
                            <p class="text-[9px] font-bold text-white/60 uppercase">Importar Archivos</p>
                            <p class="text-[7px] text-white/30 uppercase mt-1">Sube .OBJ + .MTL + Texturas</p>
                            <input type="file" id="file-input" multiple class="hidden" onchange="handleFiles(this.files)">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div><span class="text-[8px] text-white/40 block ml-1 mb-1">ESCALA</span><input type="number" id="m-scale" value="1" step="0.1" class="compact-input text-center" onchange="updateVehicle()"></div>
                            <div><span class="text-[8px] text-white/40 block ml-1 mb-1">ROTACI√ìN</span><input type="number" id="m-rot" value="0" class="compact-input text-center" onchange="updateVehicle()"></div>
                        </div>
                        <div class="pt-2 border-t border-white/10">
                            <span class="text-[9px] font-bold text-yellow-500 uppercase block mb-2">Dimensiones del Contenedor</span>
                            <div class="grid grid-cols-3 gap-1 mb-2">
                                <input type="number" id="c-w" placeholder="Ancho" class="compact-input text-center" onchange="updateVehicle()">
                                <input type="number" id="c-h" placeholder="Alto" class="compact-input text-center" onchange="updateVehicle()">
                                <input type="number" id="c-d" placeholder="Largo" class="compact-input text-center" onchange="updateVehicle()">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="c-y" placeholder="Altura Y" class="compact-input text-center" onchange="updateVehicle()">
                                <input type="number" id="c-z" placeholder="Offset Z" class="compact-input text-center" onchange="updateVehicle()">
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <div class="flex justify-between items-center mb-4">
                        <label class="text-[10px] font-black text-white/30 uppercase tracking-[0.2em]">Cajas a Cargar</label>
                        <button onclick="addNewBox()" class="text-blue-400 text-[10px] font-black hover:text-white transition-all">+ A√ëADIR LOTE</button>
                    </div>
                    <div id="box-container" class="space-y-3"></div>
                </section>
            </div>

            <button onclick="runOptimization()" class="mt-6 w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-black text-[11px] uppercase tracking-widest shadow-lg transition-all active:scale-95">
                Calcular Carga √ìptima
            </button>
        </div>
    </div>

    <div id="canvas-container" class="fixed inset-0"></div>

<script>
let scene, camera, renderer, controls, vehicleGroup, customModel;
let boxesInScene = [];
let boxTypes = [{ id: 1, w: 40, h: 40, d: 50, qty: 80, weight: 15, color: '#3b82f6', name: 'LOTE CARGA A' }];
let currentMode = 'pc';

// INICIO DE LA APP
function startApp(mode) {
    currentMode = mode;
    document.getElementById('splash-screen').style.opacity = '0';
    setTimeout(() => {
        document.getElementById('splash-screen').style.display = 'none';
        document.getElementById('stats-ui').classList.remove('hidden');
        document.getElementById('main-ui').classList.remove('hidden');
        initThree();
    }, 500);
}

function initThree() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(currentMode === 'mobile' ? 60 : 45, window.innerWidth / window.innerHeight, 1, 30000);
    camera.position.set(1200, 1200, 1200);

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    if(currentMode === 'mobile') controls.rotateSpeed = 0.6;

    // Luces
    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const sun = new THREE.DirectionalLight(0xffffff, 0.8);
    sun.position.set(1000, 2000, 1000);
    sun.castShadow = true;
    scene.add(sun);

    // Grid y Suelo
    scene.add(new THREE.GridHelper(10000, 100, 0x1e293b, 0x1e293b));

    updateVehicle();
    renderBoxUI();
    animate();
}

// GESTI√ìN DE VEH√çCULOS
function updateVehicle() {
    if(vehicleGroup) scene.remove(vehicleGroup);
    vehicleGroup = new THREE.Group();
    
    const type = document.getElementById('vehicle-select').value;
    const customUI = document.getElementById('custom-tools');
    customUI.classList.toggle('hidden', type !== 'custom');

    let v = { w: 230, h: 240, d: 500, y: 45, z: 120 }; // NPR Default

    if(type === 'tracto') v = { w: 245, h: 280, d: 1250, y: 45, z: 200 };
    if(type === 'custom') {
        v = {
            w: parseFloat(document.getElementById('c-w').value) || 240,
            h: parseFloat(document.getElementById('c-h').value) || 250,
            d: parseFloat(document.getElementById('c-d').value) || 550,
            y: parseFloat(document.getElementById('c-y').value) || 0,
            z: parseFloat(document.getElementById('c-z').value) || 0
        };
        if(customModel) {
            const s = parseFloat(document.getElementById('m-scale').value) || 1;
            customModel.scale.set(s, s, s);
            customModel.rotation.y = (parseFloat(document.getElementById('m-rot').value) || 0) * (Math.PI/180);
            vehicleGroup.add(customModel);
        }
    } else {
        // Modelo visual b√°sico para presets
        const cabina = new THREE.Mesh(new THREE.BoxGeometry(v.w, v.h*0.7, 100), new THREE.MeshStandardMaterial({color: 0x1e293b}));
        cabina.position.set(0, v.h*0.35, v.z - v.d/2 - 60);
        vehicleGroup.add(cabina);
    }

    const areaCarga = new THREE.Mesh(
        new THREE.BoxGeometry(v.w, v.h, v.d),
        new THREE.MeshStandardMaterial({ color: 0x3b82f6, transparent: true, opacity: 0.15, side: THREE.DoubleSide })
    );
    areaCarga.position.set(0, v.y + v.h/2, v.z);
    vehicleGroup.add(areaCarga);

    scene.add(vehicleGroup);
    window.vDims = v;
}

// LECTOR DE ARCHIVOS PRO
async function handleFiles(files) {
    const list = Array.from(files);
    const obj = list.find(f => f.name.toLowerCase().endsWith('.obj'));
    const mtl = list.find(f => f.name.toLowerCase().endsWith('.mtl'));
    const fbx = list.find(f => f.name.toLowerCase().endsWith('.fbx'));
    const textures = list.filter(f => /\.(jpg|png|jpeg)$/i.test(f.name));

    const manager = new THREE.LoadingManager();
    manager.setURLModifier((url) => {
        const file = textures.find(t => t.name === url.split('/').pop());
        return file ? URL.createObjectURL(file) : url;
    });

    const setModel = (m) => { customModel = m; updateVehicle(); };

    if (fbx) {
        const reader = new FileReader();
        reader.onload = (e) => setModel(new THREE.FBXLoader(manager).parse(e.target.result));
        reader.readAsArrayBuffer(fbx);
    } else if (obj) {
        if (mtl) {
            const mtlR = new FileReader();
            mtlR.onload = (me) => {
                const materials = new THREE.MTLLoader(manager).parse(me.target.result);
                materials.preload();
                const objR = new FileReader();
                objR.onload = (oe) => {
                    const loader = new THREE.OBJLoader(manager);
                    loader.setMaterials(materials);
                    setModel(loader.parse(oe.target.result));
                };
                objR.readAsText(obj);
            };
            mtlR.readAsText(mtl);
        } else {
            const objR = new FileReader();
            objR.onload = (e) => setModel(new THREE.OBJLoader(manager).parse(e.target.result));
            objR.readAsText(obj);
        }
    }
}

// CEREBRO DE OPTIMIZACI√ìN
function runOptimization() {
    boxesInScene.forEach(b => scene.remove(b));
    boxesInScene = [];
    const L = window.vDims;
    let x = -L.w/2, y = 0, z = -L.d/2, maxH = 0, maxD = 0;
    let vUsed = 0, wTotal = 0, count = 0;

    boxTypes.sort((a,b) => (b.w*b.d)-(a.w*a.d)).forEach(type => {
        for(let i=0; i < type.qty; i++) {
            if (z + type.d > L.d/2) { z = -L.d/2; x += maxD; maxD = 0; }
            if (x + type.w > L.w/2) { x = -L.w/2; z = -L.d/2; y += maxH; maxH = 0; maxD = 0; }
            if (y + type.h > L.h) break;

            const box = new THREE.Mesh(
                new THREE.BoxGeometry(type.w-0.5, type.h-0.5, type.d-0.5), 
                new THREE.MeshStandardMaterial({ color: type.color, roughness: 0.7 })
            );
            box.position.set(x + type.w/2, y + type.h/2 + L.y, z + type.d/2 + L.z);
            box.castShadow = true;
            scene.add(box);
            boxesInScene.push(box);

            z += type.d;
            maxH = Math.max(maxH, type.h);
            maxD = Math.max(maxD, type.w);
            vUsed += (type.w * type.h * type.d);
            wTotal += type.weight;
            count++;
        }
    });

    const eff = ((vUsed / (L.w*L.h*L.d))*100).toFixed(1);
    document.getElementById('stat-eff').innerText = eff + "%";
    document.getElementById('eff-bar').style.width = eff + "%";
    document.getElementById('stat-weight').innerText = wTotal.toLocaleString() + " kg";
    document.getElementById('stat-count').innerText = count;

    if(currentMode === 'mobile') toggleMobileUI();
}

// INTERFAZ DE CAJAS
function renderBoxUI() {
    document.getElementById('box-container').innerHTML = boxTypes.map((b, i) => `
        <div class="bg-white/5 p-4 rounded-2xl border border-white/5 transition-all hover:bg-white/10">
            <div class="flex justify-between mb-3">
                <input class="bg-transparent text-[10px] font-black text-blue-400 outline-none w-full" value="${b.name}" onchange="boxTypes[${i}].name=this.value">
                <button onclick="boxTypes.splice(${i},1);renderBoxUI()" class="text-white/20 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="grid grid-cols-4 gap-2">
                <div><span class="text-[7px] text-white/30 block ml-1">AN</span><input type="number" value="${b.w}" class="compact-input" onchange="boxTypes[${i}].w=Number(this.value)"></div>
                <div><span class="text-[7px] text-white/30 block ml-1">AL</span><input type="number" value="${b.h}" class="compact-input" onchange="boxTypes[${i}].h=Number(this.value)"></div>
                <div><span class="text-[7px] text-white/30 block ml-1">LA</span><input type="number" value="${b.d}" class="compact-input" onchange="boxTypes[${i}].d=Number(this.value)"></div>
                <div><span class="text-[7px] text-white/30 block ml-1">QTY</span><input type="number" value="${b.qty}" class="compact-input bg-blue-500/10" onchange="boxTypes[${i}].qty=Number(this.value)"></div>
            </div>
        </div>
    `).join('');
}

function addNewBox() {
    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
    boxTypes.push({ id: Date.now(), w: 40, h: 40, d: 40, qty: 20, weight: 10, color: colors[boxTypes.length % 5], name: 'LOTE NUEVO' });
    renderBoxUI();
}

// FUNCIONES DE SOPORTE
function toggleMobileUI() {
    if(currentMode !== 'mobile') return;
    const ui = document.getElementById('main-ui');
    const icon = document.getElementById('menu-icon');
    ui.classList.toggle('expanded');
    icon.className = ui.classList.contains('expanded') ? 'fas fa-chevron-down text-blue-500' : 'fas fa-sliders-h text-blue-500';
}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
