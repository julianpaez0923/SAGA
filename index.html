<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SAGA CARGO | COLOMBIA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/controls/OrbitControls.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { background: #020617; font-family: 'Inter', sans-serif; color: #f1f5f9; margin: 0; overflow: hidden; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        input, select { background: #1e293b !important; border: 1px solid #334155 !important; color: white !important; font-size: 14px !important; }
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        /* Fix for mobile height */
        .h-screen-safe { height: 100vh; height: -webkit-fill-available; }
    </style>
</head>
<body class="h-screen-safe flex flex-col md:flex-row overflow-hidden">

    <aside id="sidebar" class="w-full md:w-80 lg:w-96 glass flex flex-col z-30 transition-all duration-300 max-h-[40vh] md:max-h-full border-b md:border-b-0 md:border-r border-white/10">
        <div class="p-4 flex justify-between items-center">
            <div>
                <h1 class="font-bold text-blue-400 text-lg tracking-tight">SAGA <span class="text-white font-light">CARGO</span></h1>
                <p class="text-[10px] text-slate-500 uppercase font-bold">COLOMBIA</p>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-white p-2">
                <i id="toggleIcon" class="fas fa-chevron-down"></i>
            </button>
        </div>

        <div id="sidebarContent" class="p-4 space-y-5 overflow-y-auto flex-1">
            <section class="space-y-3">
                <label class="text-[10px] font-bold text-slate-500 uppercase">Espacio de Carga</label>
                <select id="mode" class="w-full p-2 rounded-lg mb-2">
                    <option value="truck">üöõ Cami√≥n / Contenedor</option>
                    <option value="rack">üèóÔ∏è Estante Industrial</option>
                </select>
                <div class="grid grid-cols-3 gap-2">
                    <input id="cw" type="number" value="240" placeholder="Ancho" class="p-2 rounded">
                    <input id="ch" type="number" value="260" placeholder="Alto" class="p-2 rounded">
                    <input id="cd" type="number" value="600" placeholder="Fondo" class="p-2 rounded">
                </div>
            </section>

            <section class="space-y-3">
                <div class="flex justify-between items-center">
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Cajas (Multi-SKU)</label>
                    <button onclick="addSKU()" class="text-[10px] bg-blue-600 px-2 py-1 rounded text-white hover:bg-blue-500">+ Agregar</button>
                </div>
                <div id="skuList" class="space-y-2">
                    </div>
            </section>

            <button onclick="calculate()" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-bold text-sm transition-all shadow-lg shadow-blue-900/40">
                <i class="fas fa-play mr-2"></i> CALCULAR ACOMODO
            </button>
        </div>

        <div class="p-4 bg-slate-900/50 border-t border-white/5 grid grid-cols-2 gap-2">
            <div class="text-center p-2 rounded bg-slate-800/50">
                <p class="text-[9px] text-slate-500 uppercase">Eficiencia</p>
                <p id="efficiency" class="font-bold text-emerald-400 text-sm">0%</p>
            </div>
            <div class="text-center p-2 rounded bg-slate-800/50">
                <p class="text-[9px] text-slate-500 uppercase">Total Cajas</p>
                <p id="fitInfo" class="font-bold text-blue-400 text-sm">0</p>
            </div>
        </div>
    </aside>

    <main class="flex-1 relative bg-[#05070a]">
        <div id="canvas" class="w-full h-full"></div>
        
        <div class="absolute bottom-6 left-1/2 -translate-x-1/2 glass px-4 py-3 rounded-2xl flex items-center gap-4 min-w-[280px] shadow-2xl">
            <button onclick="resetAnimate()" class="text-slate-400"><i class="fas fa-undo"></i></button>
            <input id="loadSlider" type="range" min="0" max="100" value="0" class="flex-1 h-1 bg-slate-700 rounded-lg appearance-none accent-blue-500" oninput="scrub(this.value)">
            <span id="stepCounter" class="text-[10px] font-mono text-blue-400">0/0</span>
        </div>
    </main>

<script>
let scene, camera, renderer, controls, boxGroup;
let skus = [{ id: 1, w: 40, h: 40, d: 40, q: 50, color: 0x3b82f6 }];
let packedBoxes = [];

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x05070a);
    
    const container = document.getElementById('canvas');
    camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 1, 10000);
    camera.position.set(500, 500, 800);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    container.appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const sun = new THREE.DirectionalLight(0xffffff, 0.6);
    sun.position.set(500, 1000, 500);
    scene.add(sun);

    renderSKUInputs();
    window.addEventListener('resize', onWindowResize);
    calculate();
}

function onWindowResize() {
    const container = document.getElementById('canvas');
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
}

function toggleSidebar() {
    const content = document.getElementById('sidebarContent');
    const icon = document.getElementById('toggleIcon');
    const sidebar = document.getElementById('sidebar');
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        sidebar.style.maxHeight = '100vh';
        icon.className = 'fas fa-chevron-up';
    } else {
        content.classList.add('hidden');
        sidebar.style.maxHeight = '60px';
        icon.className = 'fas fa-chevron-down';
    }
}

function addSKU() {
    skus.push({ id: Date.now(), w: 40, h: 40, d: 40, q: 10, color: Math.random() * 0xffffff });
    renderSKUInputs();
}

function renderSKUInputs() {
    const list = document.getElementById('skuList');
    list.innerHTML = '';
    skus.forEach((sku, idx) => {
        const div = document.createElement('div');
        div.className = 'p-3 rounded bg-slate-800/50 border border-white/5 space-y-2';
        div.innerHTML = `
            <div class="flex justify-between items-center text-[10px] font-bold">
                <span style="color: #${new THREE.Color(sku.color).getHexString()}">SKU #${idx+1}</span>
                <button onclick="removeSKU(${sku.id})" class="text-red-400 hover:text-red-300">ELIMINAR</button>
            </div>
            <div class="grid grid-cols-4 gap-1">
                <input type="number" value="${sku.w}" onchange="updateSKU(${sku.id},'w',this.value)" placeholder="W">
                <input type="number" value="${sku.h}" onchange="updateSKU(${sku.id},'h',this.value)" placeholder="H">
                <input type="number" value="${sku.d}" onchange="updateSKU(${sku.id},'d',this.value)" placeholder="D">
                <input type="number" value="${sku.q}" onchange="updateSKU(${sku.id},'q',this.value)" class="!bg-blue-900/30">
            </div>
        `;
        list.appendChild(div);
    });
}

function updateSKU(id, field, val) {
    const sku = skus.find(s => s.id === id);
    if(sku) sku[field] = parseFloat(val);
}

function removeSKU(id) {
    skus = skus.filter(s => s.id !== id);
    renderSKUInputs();
}

// ALGORITMO DE EMPAQUETADO OPTIMIZADO 
function calculate() {
    const CW = +cw.value, CH = +ch.value, CD = +cd.value;
    packedBoxes = [];
    
    // Crear lista de cajas ordenadas por volumen (Heur√≠stica)
    let items = [];
    skus.forEach(sku => {
        for(let i=0; i<sku.q; i++) items.push({...sku});
    });
    items.sort((a,b) => (b.w*b.h*b.d) - (a.w*a.h*a.d));

    let curX = 0, curY = 0, curZ = 0;
    let maxH = 0, maxD = 0;

    items.forEach(item => {
        // ¬øCabe en la fila actual?
        if (curX + item.w > CW) {
            curX = 0;
            curZ += maxD;
            maxD = 0;
        }
        // ¬øCabe en el nivel actual?
        if (curZ + item.d > CD) {
            curZ = 0;
            curX = 0;
            curY += maxH;
            maxH = 0;
        }

        if (curY + item.h <= CH) {
            packedBoxes.push({
                x: curX + item.w/2 - CW/2,
                y: curY + item.h/2 - CH/2,
                z: curZ + item.d/2 - CD/2,
                w: item.w, h: item.h, d: item.d,
                color: item.color
            });
            curX += item.w;
            maxH = Math.max(maxH, item.h);
            maxD = Math.max(maxD, item.d);
        }
    });

    update3D(CW, CH, CD);
    updateStats(CW, CH, CD);
}

function update3D(CW, CH, CD) {
    if(boxGroup) scene.remove(boxGroup);
    boxGroup = new THREE.Group();

    // Dibujar Contenedor [cite: 4, 5]
    const containerGeo = new THREE.BoxGeometry(CW, CH, CD);
    const containerMat = new THREE.MeshStandardMaterial({ color: 0x1e293b, transparent: true, opacity: 0.1, side: THREE.BackSide });
    boxGroup.add(new THREE.Mesh(containerGeo, containerMat));
    
    const edges = new THREE.LineSegments(new THREE.EdgesGeometry(containerGeo), new THREE.LineBasicMaterial({ color: 0x334155 }));
    boxGroup.add(edges);

    // Si es estante, a√±adir postes [cite: 4]
    if(document.getElementById('mode').value === 'rack') {
        const postGeo = new THREE.BoxGeometry(10, CH, 10);
        const postMat = new THREE.MeshStandardMaterial({ color: 0x475569 });
        [[-1,-1], [1,-1], [-1,1], [1,1]].forEach(p => {
            const m = new THREE.Mesh(postGeo, postMat);
            m.position.set((CW/2)*p[0], 0, (CD/2)*p[1]);
            boxGroup.add(m);
        });
    }

    // Dibujar Cajas
    packedBoxes.forEach((b, i) => {
        const geo = new THREE.BoxGeometry(b.w-1, b.h-1, b.d-1);
        const mat = new THREE.MeshStandardMaterial({ color: b.color, roughness: 0.6 });
        const box = new THREE.Mesh(geo, mat);
        box.position.set(b.x, b.y, b.z);
        box.visible = false;
        box.userData.index = i;
        
        const wire = new THREE.LineSegments(new THREE.EdgesGeometry(geo), new THREE.LineBasicMaterial({ color: 0x000000, opacity: 0.2, transparent: true }));
        box.add(wire);
        boxGroup.add(box);
    });

    scene.add(boxGroup);
    loadSlider.max = packedBoxes.length;
    loadSlider.value = packedBoxes.length;
    scrub(packedBoxes.length);
}

function scrub(val) {
    boxGroup.children.forEach(child => {
        if(child.userData.index !== undefined) {
            child.visible = child.userData.index < val;
        }
    });
    document.getElementById('stepCounter').innerText = `${val} / ${packedBoxes.length}`;
}

function resetAnimate() {
    loadSlider.value = 0;
    scrub(0);
}

function updateStats(CW, CH, CD) {
    document.getElementById('fitInfo').innerText = packedBoxes.length;
    let usedVol = 0;
    packedBoxes.forEach(b => usedVol += b.w * b.h * b.d);
    const eff = ((usedVol / (CW*CH*CD)) * 100).toFixed(1);
    document.getElementById('efficiency').innerText = eff + "%";
}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}

init();
animate();
</script>
</body>
</html>
